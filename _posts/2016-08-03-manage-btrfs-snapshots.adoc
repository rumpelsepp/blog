= Manage BTRFS Snapshots with a simple Shellscript
:page-liquid:

The standard tool for managing BTRFS snapshots seems to be `snapper`; a creepy
tool created by an openSUSE guy that integrates well into the YAST universe...
It uses XML, dbus, ..., and is written in {cpp}! Most likely you need a script
that (a) creates snapshots regularly, and (b) prunes them to save disk space.
That's the reason I created https://github.com/rumpelsepp/snap[snap].

== Motivation

The motivation of creating `snap` has been the lack of a proper btrfs snapshot
tools that just does one thing well. The reference tool for btrfs snapshots is
`snapper` which is a great piece of software. But on the other hand it includes
a lot of bloatware... It is written in {cpp}, uses dbus and xml, provides a bunch
of commands that can be done with `btrfs-progs` anyway... So, the goal of snap
is to provide a mechanism for creating and pruning btrfs snapshots easily
without requiring any additional tools but `btrfs-progs`, `coreutils` and `sh`.

== Usage

`snap` is divided into several distinct scripts `snap-COMMAND`, which are
connected with a main script `snap`; just like the early `git` collection was.
At the time of writing there are:

`snap-init`::
    Create the directory structure that is intended to contain snapshots.

`snap-create`::
    That's the main command. It creates a snapshot and inserts some autogenerated
    values into the name of the snapshot, for instance the current date and the
    type of the snapshot.

`snap-prune`::
    Used to prune the last X snapshots of a given type (hourly, daily, ...).

`snap-list`::
    More a command, that is used internally; list the available snapshot of a
    snap directory (created by `snap-init`).

=== Initialize the Directory Structure

That one is easy; just run:

----
# snap init /home/.snap
----

That command creates a btrfs subvolume `/home/.snap` which is intended to contain
snapshots. It seems to be best practice to place the "backup"-snapshots in a 
subvolume. Somewhere in the future one might be able to apply quotas or something
similar to it.

NOTE: Do not forget that only subvolumes can be snapshotted. So, `/home` *must* be 
      subvolume, otherwise it is not possible to create snapshots. You can alternatively
      snapshot `/` (might cause performance problems), or convert `/home` into a subvolume.
      I always did it like this on the tty as root (use at your own risk!): +
      (a) Backup `/home`: `mv /home /home.bak`. +
      (b) Recreate `/home`: `btrfs subvolume create /home`. +
      (c) Move the data back: `cp -a --reflink=auto /home.bak/* /home/` +
      (d) Delete the backup dir: `rm -rf /home.bak`

=== Create a Snapshot

There is `snap-create`, it takes the subvolume to snapshot, an optional type argument
and the recently created target subvolume:

----
# snap create -t hourly /home /home/.snap
Create a snapshot of '/home' in '/home/.snap/home_hourly_2016-08-03-171226'
----

=== Save Disk Space!

Yeah, run `snap-prune` and supply how many snapshots you want to _keep_; this is
my standard prune command:

----
# snap-prune -H 12 -d 14 -w 4 /home/.snap
Delete subvolume (no-commit): '/home/.snap/home_hourly_2016-08-02-221140'
Delete subvolume (no-commit): '/home/.snap/home_hourly_2016-08-02-230003'
----

=== Automate it!

Just put that commands into `/etc/crontab` that might be the easiest one. It is
also possible to create systemd timers. There are templates available at
https://github.com/rumpelsepp/snap/tree/master/etc[Github] and I have written a 
blog post about that {{ site.url }}{% post_url 2014-11-15-cron-jobs-with-systemd-timer %}[some time ago].

=== Ressources

* https://docs.sevenbyte.org/snap/
* https://github.com/rumpelsepp/snap/tree/master/man
* https://aur.archlinux.org/packages/snap/
